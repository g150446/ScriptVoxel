# マルチプレイヤーガイド

サーバーのホスト、サーバーへの接続、他のプレイヤーとScriptVoxel ブロックゲームをプレイするための完全ガイドです。

## マルチプレイヤー概要

### ネットワークモード

ScriptVoxelは3つのネットワークモードをサポートしています:

| モード | 説明 | 誰が参加できるか | 機能 |
|-------|-----|--------------|-----|
| **シングルプレイヤー** | ローカルプレイのみ | 誰も | Pythonエージェント、オフライン |
| **クライアント** | サーバーに接続 | あなたのみ | リモートワールドでプレイ |
| **ホスト** | サーバーを実行 + プレイ | 最大31人 | 完全な制御、マルチプレイヤー |

### 重要な概念

**サーバー権限地形**:
- サーバーがすべての地形とブロック編集を制御
- クライアントはブロック変更のリクエストを送信
- サーバーが検証して変更を適用
- すべてのプレイヤー間で一貫性を確保

**クライアント権限物理**:
- 各プレイヤーが自分の移動を制御
- サーバーによる位置検証なし(信頼ベース)
- スムーズなローカル移動
- 他のプレイヤーに位置をブロードキャスト

**ピアツーピアアーキテクチャ**:
- ENetネットワーキングプロトコルを使用
- クライアントとサーバー間の直接接続
- 低遅延のためのUDPベース
- 信頼性のあるメッセージと信頼性のないメッセージのサポート

## サーバーのホスト

### ステップバイステップサーバーセットアップ

**1. メインメニューから**:
- **「サーバーをホスト」**ボタンをクリック
- サーバー構成画面が表示されます

**2. サーバー設定を構成**:

**ポート番号**:
- デフォルト: **25000**(UDP)
- 1024-65535の任意のポートを使用可能
- この番号を覚えておいてください - クライアントが接続するために必要です

**UPNPオプション**(チェックボックス):
- **有効**: 自動ポート転送(最も簡単)
- **無効**: 手動ポート転送が必要(上級)

**3. サーバーを開始**:
- **「サーバーをホスト」**ボタンをクリック
- サーバーが初期化されます
- ウィンドウタイトルが「サーバー」に変わります
- プレイヤー1としてワールドにスポーンします

**4. 接続情報を共有**:
- プレイヤーに**IPアドレス**と**ポート番号**を伝えます
- LAN用: ローカルIP(192.168.x.x)を使用
- インターネット用: パブリックIP(Google「what is my IP」)を使用

### サーバー機能

**最大プレイヤー数**: 32同時接続
- あなた(ホスト)がプレイヤー1としてカウント
- 最大31人の追加プレイヤーが参加可能
- サーバーピアIDは常に1

**サーバー権限**:
- すべての地形変更はサーバーを経由
- 草の広がりシミュレーションがサーバーで実行
- 水シミュレーションがサーバーで実行
- ブロック編集が検証されてクライアントに配布

**サーバー機能**:
- クライアントへのリアルタイム地形同期
- 接続された各プレイヤー用にVoxelViewerを作成
- プレイヤー位置に基づく自動チャンクストリーミング
- ネットワーク効率的なボクセルデータ圧縮

### ポート転送

**UPnPを使用しない**場合、ポートを手動で転送する必要があります:

**ルーター構成**:
1. ルーター管理パネルにアクセス(通常 http://192.168.1.1 または http://192.168.0.1)
2. ルーター認証情報でログイン
3. **「ポート転送」**または**「仮想サーバー」**セクションを見つける
4. 新しいルールを作成:
   - **外部ポート**: 25000(または選択したポート)
   - **内部ポート**: 25000(外部と同じ)
   - **内部IP**: コンピュータのローカルIP
   - **プロトコル**: **UDP**(TCPではありません!)
5. 設定を保存して適用

**ローカルIPの確認**:
- **Windows**: CMDを開き、`ipconfig`と入力、IPv4アドレスを探す
- **Mac**: システム環境設定 → ネットワーク、IPアドレスを探す
- **Linux**: ターミナルで`hostname -I`と入力

**ポート転送のテスト**:
- オンラインポートチェッカーツールを使用
- 友達に接続を試してもらう
- ルーターログで接続試行を確認

### UPnP自動ポート転送

**UPnPとは?**
- Universal Plug and Play
- 自動ルーター構成
- 手動セットアップ不要

**使用方法**:
1. サーバーセットアップでUPnPチェックボックスを有効化
2. 「サーバーをホスト」をクリック
3. ゲームが自動的にルーターを構成
4. ポート転送が自動的に作成

**要件**:
- ルーターがUPnPをサポートしている必要
- ルーター設定でUPnPが有効化されている必要
- すべてのルーターがサポートしているわけではありません

**トラブルシューティング**:
- UPnPが失敗した場合、代わりに手動ポート転送を使用
- UPnP設定のためにルーター管理パネルを確認
- 一部のISPはUPnPをブロックします

### サーバーの実行

**サーバー実行中**:
- 通常通りプレイできます(あなたもプレイヤーです)
- ウィンドウのタイトルバーに「サーバー」が表示されます
- すべてのシミュレーションがあなたのマシンで実行されます
- 他のプレイヤーがあなたに接続します

**サーバーパフォーマンス**:
- コンピュータを実行し続ける必要があります
- 他のプレイヤーはあなたの接続に依存します
- より高いシステムリソース使用量(ホスティング+プレイ)
- ネットワークアップロード帯域幅が重要

**サーバーの停止**:
- ゲームウィンドウを通常通り閉じる
- シャットダウン前に**ワールドが自動保存**されます
- 接続されているすべてのクライアントが切断されます
- 彼らは「サーバー切断」メッセージを見ます

## サーバーへの接続(クライアントモード)

### ステップバイステップクライアント接続

**1. メインメニューから**:
- **「サーバーに接続」**ボタンをクリック
- クライアント構成画面が表示されます

**2. サーバー情報を入力**:

**サーバーIPアドレス**:
- サーバーホストから取得
- LAN用: ローカルIP(例: 192.168.1.100)
- インターネット用: パブリックIP(例: 203.0.113.45)
- ローカルテスト用: **127.0.0.1**(localhost)

**ポート**:
- デフォルト: **25000**
- サーバーのポートと正確に一致する必要があります
- 異なる場合はホストに尋ねる

**3. 接続**:
- **「サーバーに接続」**ボタンをクリック
- ゲームが接続を試行
- 「接続中...」ステータスを表示

**4. 地形ダウンロード**:
- 接続成功！
- サーバーから地形のダウンロードを開始
- ワールドサイズによっては数秒かかる場合があります
- サーバーのワールドにスポーンします

### クライアント機能

**できること**:
- 自由に移動して探索
- ブロックを配置して削除(サーバー経由)
- リアルタイムで他のプレイヤーを見る
- ワールドと相互作用
- すべてのブロックとアイテムを使用

**できないこと**:
- Pythonエージェントエディタにアクセス(ホスト/シングルプレイヤーのみ)
- シミュレーションを実行(草の広がり、水の流れ) - サーバーがこれを処理
- サーバーがオフラインの場合プレイ
- サーバー地形決定をオーバーライド

### クライアント機能

**地形同期**:
- 探索するときの地形の自動ダウンロード
- 効率のために圧縮されたボクセルデータ
- 位置に基づくストリーミング
- VoxelTerrainMultiplayerSynchronizerがこれを処理

**プレイヤーインタラクション**:
- 他のプレイヤーの移動を見る
- 他の人によって配置/削除されるブロックを見る
- リアルタイム協力

**ネットワーク権限**:
- あなたの移動はクライアント権限(あなたが制御)
- ブロック編集はサーバー権限(サーバーが検証)
- 最小限のラグでスムーズなゲームプレイ

## 接続問題のトラブルシューティング

### サーバーに接続できない

**これらを確認**:
1. **サーバーが実行中**: ホストにサーバーがアクティブであることを確認
2. **正しいIP**: IPアドレスを再確認(タイプミスなし)
3. **正しいポート**: ポート番号がサーバーと一致することを確認
4. **ファイアウォール**: テストのためにファイアウォールを一時的に無効化
5. **ルーター**: ポート転送が正しく構成されていることを確認(ホスト側)
6. **同じバージョン**: クライアントとサーバーは同じゲームバージョンを使用する必要

**一般的な問題**:
- **「接続失敗」**: サーバーに到達できません(IP/ポートを確認)
- **タイムアウト**: ファイアウォールまたはルーターが接続をブロック
- **間違ったIP**: 間違ったネットワークインターフェースIPを使用

### ラグまたはパフォーマンスの問題

**クライアント側ラグ**:
- **原因**: 遅いインターネット、高いping、サーバーが遠すぎる
- **解決策**: インターネット接続を確認、代わりにローカルサーバーを試す

**サーバー側ラグ**:
- **原因**: プレイヤーが多すぎる、サーバーコンピュータが遅い、シミュレーションの過負荷
- **解決策**: プレイヤー数を減らす、サーバーハードウェアをアップグレード

**地形読み込みが遅い**:
- **原因**: 大きなワールド、遅い接続、サーバー帯域幅制限
- **解決策**: 辛抱強く待つ、ストリーミングを許可するためにゆっくり移動、ホストにアップロード速度の改善を依頼

## マルチプレイヤーゲームプレイ

### 他の人とのプレイ

**調整**:
- 外部音声/テキストチャット経由で通信(ゲーム内チャットなし)
- 競合を避けるために建築エリアについて合意
- リソースを精神的に共有(すべてのアイテムは無限なので)

**協力**:
- 大規模プロジェクトで一緒に建築
- 一人が配置、もう一人がデザイン
- 異なるセクションで同時に作業

**尊重**:
- 許可なしに他の人の建物を破壊しないでください
- 共有構造を変更する前に尋ねる
- 水に注意(建物を浸水させる可能性)

### ネットワーク動作

**あなたのアクション**:
- **移動**: ローカルで即座、サーバー/他の人にブロードキャスト
- **ブロック配置**: サーバーに送信、検証、すべてのクライアントに同期
- **ブロック削除**: 配置と同じ(サーバーが検証)

**他の人のアクション**:
- **移動**: RPC経由で受信、クライアントで更新
- **ブロック編集**: サーバーが更新を送信、クライアントが適用
- **シミュレーション**: サーバーのみが実行、結果を見る

**同期の詳細**:
- **信頼性のあるRPC**: ブロック編集(到着必須)
- **信頼性のないRPC**: プレイヤー位置(パケットをドロップ可能)
- **VoxelTerrainMultiplayerSynchronizer**: ボクセル同期を自動的に処理

### 特殊なマルチプレイヤー機能

**VoxelViewerシステム**:
- 各プレイヤーがサーバー上にVoxelViewerノードを持つ
- そのプレイヤーのために読み込む必要がある地形をマーク
- ビューワー位置に基づいてサーバーが地形チャンクを送信
- 移動するときの自動地形ストリーミング

**リモートプレイヤーアバター**:
- 他のプレイヤーがキャラクターアバターとして表示
- リアルタイムで移動が同期
- 向きと位置を見られる
- 他のプレイヤーとの衝突なし(互いに通り抜けられる)

**地形の永続性**:
- すべてのブロック編集がサーバーに保存
- 再接続すると、ワールドは以前のまま
- サーバーがシャットダウン時に自動保存

## マルチプレイヤーの制限

**現在の制限**:

**音声/テキストチャットなし**:
- 外部プログラム(Discord、TeamSpeakなど)を使用
- ゲーム内通信システムなし

**権限/ロールなし**:
- すべてのプレイヤーが平等な編集権を持つ
- 管理者コントロールやプレイヤーランクなし
- 信頼ベースのシステム

**プレイヤーリストなし**:
- オンラインの人を見られない
- スコアボードやプレイヤー名簿なし
- 手動で追跡する必要

**スポーン保護なし**:
- プレイヤーはどこでも編集可能
- 保護ゾーンやクレームなし
- 建築制限なし

**プレイヤー名なし**:
- プレイヤーの上に名前タグなし
- 誰が誰かを視覚的に識別できない
- 外部で調整する必要

## 高度なマルチプレイヤートピック

### ネットワーク権限の詳細

**クライアント権限(プレイヤー物理)**:
- サーバーに位置更新を送信
- サーバーが他のクライアントにブロードキャスト
- サーバー検証なし(信頼ベース)
- スムーズな移動、チートの可能性

**サーバー権限(地形)**:
```
クライアント → RPCリクエスト → サーバー
サーバー → 検証 → 変更を適用
サーバー → 同期 → 全クライアント
```

**なぜこのハイブリッド?**:
- プレイヤーの移動が応答性がある
- 地形変更が一貫している
- パフォーマンスとセキュリティのバランス

### RPC(リモートプロシージャコール)システム

**ブロック編集の仕組み**:
1. ブロックを配置するために右クリック
2. クライアントがRPCを呼び出す: `receive_place_single_block(position, block_id)`
3. サーバーがRPCを受信
4. サーバーが検証: このブロックをここに配置できるか?
5. サーバーが地形にブロックを配置
6. VoxelTerrainMultiplayerSynchronizerがすべてのクライアントに自動的に更新を送信
7. すべてのクライアントが変更を受信して表示

**プレイヤー位置同期**:
1. 毎フレーム、RPC経由で位置をブロードキャスト
2. サーバーが受信して無視(クライアントが処理)
3. 他のクライアントがあなたの位置を受信
4. 他のクライアントが画面上であなたのアバター位置を更新

**RPCタイプ**:
- **信頼性のある**: 到着必須、順序通り(ブロック編集)
- **信頼性のない**: ドロップ可能、より速い(プレイヤー位置)

### ネットワークパフォーマンス最適化

**サーバー最適化**:
- シミュレーション範囲を減らす(草の広がり、水の流れ)
- プレイヤー数を制限
- より速いハードウェアを使用
- 良いインターネットアップロード速度(重要!)

**クライアント最適化**:
- 速いダウンロード速度
- サーバーへの低いping
- 安定した接続

**帯域幅使用**:
- 初期地形ダウンロード: 中程度(1回限り)
- 継続的な同期: 低(変更のみ)
- プレイヤー位置: 非常に低(小さなパケット)

## ホスティングのベストプラクティス

**サーバーホスト用**:

1. **安定した接続**: Wi-Fiではなく有線イーサネットを使用
2. **良いアップロード速度**: 10人以上のプレイヤーには5+ Mbps推奨
3. **サーバーを実行し続ける**: 予期せずシャットダウンしない
4. **通信**: サーバーがオフラインになる時期をプレイヤーに伝える
5. **ワールドをバックアップ**: 保存ファイルを定期的にコピー(手動)
6. **パフォーマンスを監視**: ラグを監視、必要に応じてプレイヤー数を調整

**プレイヤー用**:

1. **ホストを尊重**: 彼らは無料でサーバーを提供しています
2. **荒らさない**: 他の人の作品を破壊しないでください
3. **我慢強く**: 地形の読み込みには時間がかかります
4. **調整**: 外部チャットを使用してコミュニケーション
5. **メンタルチェックポイントを保存**: サーバーがクラッシュする可能性、準備を

## ローカルマルチプレイヤー(LAN)

**同じネットワークプレイ**:
- 最も簡単なマルチプレイヤーセットアップ
- ホストがローカルIP(192.168.x.x)を使用
- ポート転送不要
- 低遅延、高パフォーマンス

**セットアップ**:
1. ホストがデフォルトポート(25000)でサーバーを開始
2. ホストがローカルIPアドレスを確認
3. クライアントがホストのローカルIPを使用して接続
4. 全員が同じLANでプレイ

**最適な用途**:
- LANパーティー
- 家族/同居人とのプレイ
- インターネットホスティング前のテスト

## インターネットマルチプレイヤー(WAN)

**クロスインターネットプレイ**:
- より複雑なセットアップ
- ポート転送またはUPnPが必要
- LANより高い遅延
- よりやりがいのある(遠くの友達とプレイ)

**セットアップ**:
1. ホストがポート転送を構成(またはUPnPを有効化)
2. ホストがパブリックIPアドレスを確認
3. ホストがクライアントとパブリックIP + ポートを共有
4. クライアントがパブリックIPを使用して接続

**課題**:
- 動的IP(変更される可能性)
- NATトラバーサル
- ファイアウォール構成
- ISP制限

---

**以上です!** これでマルチプレイヤーでScriptVoxelを楽しむ準備が整いました。友達と楽しい建築を！

**戻る**: [マニュアルインデックス](./README.md)
